name: Version and Release

on:
  release:
    types: [created]

jobs:
  version-and-release:
    name: Update Version and Create Release Asset
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Tag: $TAG_NAME"

      - name: Replace __VERSION__ in plugin file
        run: |
          sed -i "s/__VERSION__/${{ steps.get_version.outputs.version }}/g" lottie-lite.php
          echo "Updated plugin header:"
          cat lottie-lite.php | grep "Version:"

      - name: Commit version changes to tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add and commit the versioned file
          git add lottie-lite.php
          git commit -m "Update version to ${{ steps.get_version.outputs.version }}"

          # Delete the old tag and create a new one pointing to the new commit
          git tag -d "${{ steps.get_version.outputs.tag }}"
          git tag -a "${{ steps.get_version.outputs.tag }}" -m "Release ${{ steps.get_version.outputs.tag }}"

          # Force push the updated tag
          git push origin "${{ steps.get_version.outputs.tag }}" --force

      - name: Create ZIP archive
        run: |
          mkdir -p release

          # Create a clean copy excluding dev files
          rsync -av --exclude='.git' \
                    --exclude='.github' \
                    --exclude='node_modules' \
                    --exclude='src' \
                    --exclude='tests' \
                    --exclude='release' \
                    --exclude='.gitignore' \
                    --exclude='.gitattributes' \
                    --exclude='.editorconfig' \
                    --exclude='.wp-env' \
                    --exclude='.wp-env.json' \
                    --exclude='playwright.config.js' \
                    --exclude='package.json' \
                    --exclude='package-lock.json' \
                    --exclude='composer.json' \
                    --exclude='CLAUDE.md' \
                    --exclude='README.md' \
                    ./ release/lottie-lite/

          # Create ZIP
          cd release
          zip -r "lottie-lite-${{ steps.get_version.outputs.tag }}.zip" lottie-lite/
          cd ..

          echo "Created: release/lottie-lite-${{ steps.get_version.outputs.tag }}.zip"

      - name: Upload ZIP to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            release/lottie-lite-${{ steps.get_version.outputs.tag }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
